{% extends "base.html" %}

{% block content %}
<div class="quiz-wrapper">
  <!-- Cabeçalho -->
  <div class="quiz-header">
    <h1 class="quiz-title">Quiz!</h1>
    <p class="quiz-progress">Pergunta {{ current }}/{{ total }}</p>
    <div class="progress-bar">
      <div class="progress-fill" style="width: {{ current / total * 100 }}%"></div>
    </div>
    <p class="quiz-timer">⏱ <span id="timer-display">02:00</span></p>
  </div>

  <!-- Pergunta -->
  <div class="quiz-question">
    <h2>{{ question.text }}</h2>
  </div>

  <!-- Opções -->
  <div class="quiz-options">
    <button class="option-btn" onclick="submitAnswer(1)">{{ question.option1 }}</button>
    <button class="option-btn" onclick="submitAnswer(2)">{{ question.option2 }}</button>
    <button class="option-btn" onclick="submitAnswer(3)">{{ question.option3 }}</button>
    <button class="option-btn" onclick="submitAnswer(4)">{{ question.option4 }}</button>
  </div>

  <!-- Feedback -->
  <div id="feedback" class="feedback"></div>

  <!-- Sons -->
  <audio id="whistle-sound" src="{{ url_for('static', filename='whistle.mp3') }}"></audio>
  <audio id="correct-sound" src="{{ url_for('static', filename='goal.mp3') }}"></audio>
  <audio id="wrong-sound" src="{{ url_for('static', filename='error.mp3') }}"></audio>
</div>

<script>
let timeLeft = 120; // 2 minutos
const timerElement = document.getElementById("timer-display");
const whistleSound = document.getElementById('whistle-sound');
const correctSound = document.getElementById('correct-sound');
const wrongSound = document.getElementById('wrong-sound');

let whistlePlayed = false;

window.addEventListener("DOMContentLoaded", () => {
    whistleSound.play().then(() => { whistlePlayed = true; }).catch(() => {});
    startTimer();
});

function startTimer() {
    setInterval(updateTimer, 1000);
}

function updateTimer() {
    if (timeLeft <= 0) {
        playFinalSoundAndRedirect();
        return;
    }

    if (timeLeft === 10) { // alerta de 10s
        whistleSound.play();
    }

    let minutes = Math.floor(timeLeft / 60);
    let seconds = timeLeft % 60;
    timerElement.textContent =
        (minutes < 10 ? "0" : "") + minutes + ":" +
        (seconds < 10 ? "0" : "") + seconds;

    timeLeft--;
}

function playFinalSoundAndRedirect() {
    whistleSound.play().finally(() => {
        const wrapper = document.querySelector('.quiz-wrapper');
        wrapper.classList.add('fade-out');
        setTimeout(() => window.location.href = "{{ url_for('quiz_result') }}", 500);
    });
}

function submitAnswer(optionId) {
    if (!whistlePlayed) {
        whistleSound.play();
        whistlePlayed = true;
    }

    const buttons = document.querySelectorAll('.option-btn');
    const questionDiv = document.querySelector('.quiz-question');

    fetch('{{ url_for("quiz_answer", question_id=question.id) }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ selected_option: optionId })
    })
    .then(response => response.json())
    .then(data => {
        const feedbackDiv = document.getElementById('feedback');
        buttons.forEach(btn => {
            btn.disabled = true;
            btn.classList.add('disabled');
        });

        let nextUrl = data.next_question_url || "{{ url_for('quiz_result') }}";
        const blinkDuration = 800;
        const blinkCount = 2;

        function proceedNext() {
            const wrapper = document.querySelector('.quiz-wrapper');
            wrapper.classList.add('fade-out');
            setTimeout(() => { window.location.href = nextUrl; }, 500);
        }

        if (data.correct) {
            feedbackDiv.textContent = '✅ Correto!';
            feedbackDiv.className = 'feedback correct';
            correctSound.play();
            buttons[optionId - 1].classList.add('blink-green', 'correct-zoom');
            questionDiv.classList.add('correct-question');
        } else {
            feedbackDiv.textContent = '❌ Errado! Resposta certa: ' + data.correct_answer;
            feedbackDiv.className = 'feedback wrong';
            wrongSound.play();

            buttons[optionId - 1].classList.add('blink-red');
            if (data.correct_option) {
                const correctIndex = data.correct_option - 1;
                buttons[correctIndex].classList.add('blink-blue', 'correct-zoom');
            }
            questionDiv.classList.add('wrong-question');
        }

        proceedNext();
    })
    .catch(() => window.location.href = "{{ url_for('quiz_result') }}");
}
</script>

<style>
/* Quiz base */
.quiz-wrapper { max-width: 650px; margin: 50px auto; text-align: center; background: var(--card); color: var(--text); padding: 40px 30px; border-radius: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.4); font-family: 'Arial', sans-serif; }
.quiz-header { margin-bottom: 25px; }
.quiz-title { font-size: 38px; font-weight: 700; color: var(--accent); margin-bottom: 10px; }
.quiz-progress { font-size: 16px; color: var(--text); margin: 5px 0; }
.quiz-timer { font-size: 32px; font-weight: bold; color: #ffcb3f; background: rgba(0,0,0,0.3); padding: 6px 18px; border-radius: 8px; display: inline-block; letter-spacing: 2px; margin-top: 10px; }
.quiz-question h2 { font-size: 26px; margin: 25px 0; color: var(--text); }
.quiz-options { display: grid; gap: 15px; margin-top: 25px; }
.option-btn { padding: 16px; font-size: 18px; font-weight: bold; border-radius: 50px; border: none; background: var(--accent); color: var(--card); cursor: pointer; transition: transform 0.2s, background 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.25); }
.option-btn:disabled, .option-btn.disabled { cursor: not-allowed; opacity: 0.6; pointer-events: none; }
.option-btn:hover:enabled { transform: scale(1.05); background: #ffc107; }
.feedback { margin-top: 28px; font-size: 20px; font-weight: bold; }
.feedback.correct { color: #27ae60; }
.feedback.wrong { color: #e74c3c; }

/* Barra de progresso */
.progress-bar { background: #ddd; border-radius: 10px; height: 10px; margin: 15px 0; }
.progress-fill { height: 10px; background: #27ae60; border-radius: 10px; transition: width 0.3s ease; }

/* Piscar e zoom */
@keyframes blink-green { 0%,100% { background-color: #27ae60; } 50% { background-color: var(--accent); } }
@keyframes blink-red { 0%,100% { background-color: #e74c3c; } 50% { background-color: var(--accent); } }
@keyframes blink-blue { 0%,100% { background-color: #3498db; } 50% { background-color: var(--accent); } }
.blink-green { animation: blink-green 0.8s ease 0s 2; }
.blink-red { animation: blink-red 0.8s ease 0s 2; }
.blink-blue { animation: blink-blue 0.8s ease 0s 2; }

.correct-zoom { animation: zoom 0.6s ease 0s 1; }
@keyframes zoom { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }

/* Destaque pergunta */
.correct-question { animation: highlight-green 0.8s ease 0s 2; }
.wrong-question { animation: highlight-red 0.8s ease 0s 2; }
@keyframes highlight-green { 0%,100% { background-color: #27ae60; } 50% { background-color: transparent; } }
@keyframes highlight-red { 0%,100% { background-color: #e74c3c; } 50% { background-color: transparent; } }

/* Fade-out */
.fade-out { animation: fadeOut 0.5s forwards; }
@keyframes fadeOut { 0% { opacity: 1; } 100% { opacity: 0; } }
</style>
{% endblock %}
